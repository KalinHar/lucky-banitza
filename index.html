<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <link rel="icon" type="image/png" href="assets/26.png">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <title>БАНИЦА</title>
</head>

<body>
    <div id="app">
        <div class="header">
            <span>Заповядайте на баницата! Моля, не бъдете лакоми, количествата са ограничени!</span>
        </div>
        <div class="banitza">
            <img :class="[spin ? 'banitza-anim' : '', 'banitza-img']" :src="`./assets/${lucks.length}.png`" @click="inputOpen = true">
        </div>
        <div v-if="inputOpen" class="mask">
            <div class="email-input">
                <div class="close" @click="inputOpen = false">
                    <span class="close-email">x</span>
                </div>
                <div class="flex">
                    <input type="text" v-model="emailPrefix" placeholder="username" />
                    <span type="button" class="email-suffix" @click="choosePiece">{{emailSuffix}}</span>
                </div>
            </div>
        </div>
        <div v-if="luck" class="mask">
            <div class="luck">
                <div class="close" @click="toCongrats">
                    <span>x</span>
                </div>
                <p class="strong">{{luck}}</p>
            </div>
        </div>

        <div v-if="congrats" class="full">
            <div class="close-grandpa" @click="toCongrats">
                <span>x</span>
            </div>
            <img src="assets/wishes.png" class="congrats">
        </div>

        <div class="lucks">
            <template v-for="email in emails">
                <div v-if="email.luck.length > 0">
                    <p><u>{{email.name}}</u>: {{email.luck}}</p>
                </div>
            </template>
        </div>
    </div>
</body>

</html>

<script>
    const { createApp } = Vue;

    const company = 'vilnaZona';
    const back4appUrl = 'https://parseapi.back4app.com/classes/'
    const usersUrl = `${back4appUrl}${company}Users`;
    const lucksUrl = `${back4appUrl}${company}Lucks`;
    const btnTextUrl = `${back4appUrl}${company}Submit`;
    const setLuckUrl = (id) => `${usersUrl}/${id}`;
    const headers = {
        'X-Parse-Application-Id': 'iX8L6TXUOwc7xTyXbXUGXGbnHfdASV0nt3Kn0YAL',
        'X-Parse-REST-API-Key': 'Qm3WSavGyV7lAiWSDyuBSRJGkM6UKY7l5Ff9CiAn'
    }

    createApp({
        data() {
            return {
                lucks: [],
                luck: '',
                emails: [],
                email: {},
                emailPrefix: "",
                inputOpen: false,
                congrats: false,
                spin: false,
                emailSuffix: '',
                companyLucks: []
            }
        },
        computed: {
            fullEmail() {
                return this.emailPrefix.toLowerCase() + this.emailSuffix;
            }
        },
        async mounted() {
            await this.getCompanyData();
            await this.setLocalState();

            // Clear remote lucks

            // for await (const email of this.emails) {
            //     if (email.luck.length > 0)
            //         fetch(`https://parseapi.back4app.com/classes/vizitec/${email.objectId}`, {
            //             method: 'PUT',
            //             body: JSON.stringify({ luck: '' }),
            //             headers
            //         });
            // }
        },
        methods: {
            async getCompanyData() {
                const lucksResponse = await fetch(lucksUrl, { headers });
                const lucksResult = await lucksResponse.json();
                this.companyLucks = lucksResult.results.map(luck => luck.text);

                const btnTextResponse = await fetch(btnTextUrl, { headers });
                const btnTextResult = await btnTextResponse.json();
                this.emailSuffix = btnTextResult.results[0].btnText;
            },
            async choosePiece() {
                await this.setLocalState();
                const emailIndex = this.emails.findIndex(obj => obj.email === this.fullEmail);

                if (emailIndex > -1) {
                    this.inputOpen = false;
                    this.email = this.emails[emailIndex]
                    this.emails[emailIndex].luck.length
                        ? alert('Вече си изтеглил късмет от баницата!')
                        : this.pickLuck();
                } else {
                    alert('Въведен е невалиден e-mail');
                }
            },
            async pickLuck() {
                this.spin = true;
                await this.setLocalState();
                await setTimeout(async () => {
                    this.luck = this.lucks[Math.round(Math.random() * (this.lucks.length - 1))];
                    await this.setLuckRemote();
                    await this.setLocalState();
                }, 2500);
            },
            async setLocalState() {
                this.emails = await this.getAllEmails();
                const usedLucks = this.emails.map(email => email.luck);
                this.lucks = this.companyLucks.filter(luck => !usedLucks.includes(luck));
            },
            async getAllEmails() {
                const emailsResponse = await fetch(usersUrl, { headers });
                const emailsResult = await emailsResponse.json();
                return emailsResult.results;
            },
            async setLuckRemote() {
                const luckResponse = await fetch(setLuckUrl(this.email.objectId), {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({ luck: this.luck })
                });
            },
            toCongrats() {
                this.luck = '';
                this.congrats = !this.congrats;
                this.spin = false;
            }
        }
    }).mount('#app')
</script>

<style>
    /* @font-face {
        font-family: "ClassRoomCursiveSwash";
        src: url("assets/ClassRoomCursiveSwash.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
    } */

    /* @font-face {
        font-family: "Roboto";
        src: url("assets/Roboto-Regular.ttf") format("truetype")
    } */
    
    @font-face {
        font-family: "Nautilus";
        src: url("assets/Nautilus.otf");
    }

    body {
        touch-action: pan-y;
        background: url("assets/bkg.png");
        /* background-size: cover; */
        font-family: "Nautilus";
    }

    #app {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .banitza {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .banitza-img {
        width: 100%;
        height: auto;
        cursor: pointer;
    }

    .banitza-anim {
        animation: spin 2.5s ease-out 1;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(720deg);
        }
    }

    .piece {
        cursor: pointer;
        background-color: yellow;
        padding: 5px
    }

    .mask {
        padding: 5rem;
        position: absolute;
        background-color: rgb(0, 0, 0, 0.3);
        top: 12rem;
    }

    .luck {
        width: 375px;
        height: 225.5px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        background: url("assets/papyrus.png");
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .lucks {
        width: 100%;
        padding: 1rem;
    }

    .strong {
        padding-inline: 2rem;
        font-size: x-large;
    }

    .close {
        position: absolute;
        top: 1rem;
        right: 2rem;
        cursor: pointer;
    }

    .close-grandpa {
        position: absolute;
        top: 1rem;
        cursor: pointer;
        width: 100%;
        max-width: 500px;
        display: flex;
        justify-content: flex-end;
        padding-right: 1rem;
    }

    .close-grandpa span,
    .close span {
        font-family: 'Courier New';
        margin: 0.2rem
    }

    .close-congrats {
        position: absolute;
        top: 45%;
        right: 45%;
        cursor: pointer;
    }

    .email-input {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        gap: 0.5rem;
        text-align: center;
    }

    .email-input input {
        width: 7rem !important;
        padding: 8px 10px;
        font-size: 1.2rem;
        border: 1px solid #ccc;
        border-radius: 6px 0 0 6px;
        outline: none;
        width: fit-content;
    }

    .email-suffix {
        padding: 8px 10px;
        background: #eee;
        border: 1px solid #ccc;
        border-left: none;
        border-radius: 0 6px 6px 0;
        font-size: 1.2rem;
        color: #555;
        cursor: pointer;
    }

    .email-suffix:hover {
        background: #fff;
    }

    .header {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .header span {
        padding-inline: 2rem;
        font-size: x-large;
        text-align: center;
    }

    .congrats {
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 500px;
    }

    .close-email {
        background-color: white;
        padding: .3rem;
        border-radius: 3px;
    }

    .full {
        width: 100%;
        position: absolute;
        top: 10%;
        display: flex;
        justify-content: center;
    }

    .flex {
        display: flex;
    }
</style>






