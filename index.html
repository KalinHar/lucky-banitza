<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="assets/26.png">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <title>БАНИЦА</title>
</head>

<body>
    <div id="app">
        <div class="banitza">
            <audio ref="xMusic" src="assets/xmas-music.mp3" loop></audio>
            <img class="banitza-img" :src="`./assets/${lucks.length}.png`" @click="onBanitzaClick">
        </div>
        <div v-if="wish" class="mask">
            <div class="wish">
                <div class="close" @click="toCongrats">
                    <span>x</span>
                </div>
                <strong>{{wish}}</strong>
            </div>
        </div>
        <div v-if="inputOpen" class="mask">
            <div class="email-input">
                <strong>С баница се почерпи и късметче получи</strong>
                <div>
                    <input type="text" v-model="emailPrefix" placeholder="username" />
                    <span type="button" class="email-suffix" @click="choosePiece">{{emailSuffix}}</span>
                </div>
            </div>
        </div>
        <div v-if="congrats" class="mask">
            <div class="congrats">
            </div>
        </div>
        <div class="footer">
            <span>Заповядайте на баницата. Моля не бъдете лакоми, количествата са ограничени</span>
        </div>
    </div>
</body>

</html>

<script>
    const { createApp } = Vue;

    const getAllUrl = 'https://parseapi.back4app.com/classes/vizitec';
    const setLuckUrl = (id) => `${getAllUrl}/${id}`;
    const headers = {
        'X-Parse-Application-Id': 'bRrAggyHMoMVL9uPNl4T9XPzDFxHMRIrxTEieDEN',
        'X-Parse-REST-API-Key': 'oyNNM1odjhrSzfCkWtVmkFTiZPgmZUelFFkE5uhX'
    }

    const allLucks = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26'];
    const wishes = {
        '1': 'Повишение със сигурност ще имаш ти, защото шефа страшно те цени.',
        '2': 'Стягай се за почерпка отсега – през новата година ще подкараш нова кола.',
        '3': 'На вратата, като че ли нещо тебе чака и това не са сметките за тока и водата...Май са топка пелени и бебенце ще чакаш ти.',
        '4': 'Очакват те безброй нови имоти, купени с неочаквани наследствени банкноти.',
        '5': 'Любов ще грее силно твоето сърце, като чисто ново циганско кюмбе.',
        '6': 'Хм, я вземи чадъра и наопаки го обърни, че за теб от утре започва порой от пари.',
        '7': 'Знаем, хич не ти спори учението. Затова на теб се пада приключението.',
        '8': 'Безкрайно веселие и купон подир купон, от тебе се очаква само да даваш тон!',
        '9': 'На тебе мързелът се пада – да мързелуваш ти приляга!',
        '10': 'Плюй си на петите и беж, че очаква те годеж!',
        '11': 'Най-голямата награда – здравето – на теб се пада!',
        '12': 'Годината ще е добра, ще я отбележиш с пътуване до тайнствена страна!',
        '13': 'Ще бъдеш със сила и смелост окрилен, повече даже и от Спайдърмен!',
        '14': 'Стилна къща с камина пада ти се таз година! С двор, с гараж и с куче – нов, мечтан дом ще получиш!',
        '15': 'Ех, най-добрия късмет случи – пада ти се здраве и благополучие! ',
        '16': 'Хич да не ти пука – догодина наслука!',
        '17': 'Късметът на теб се пада, ще си облечен в дрехи на Прада!',
        '18': 'Кариерата ще ти е приоритет, ще се изкачваш смело напред!',
        '19': 'Няма да се отървеш от фенки, ще им трябват наколенки.',
        '20': 'Раничката си стегни, ще караш ски във чужди планини!',
        '21': 'Щастието ще е с теб, ще отидеш на гурбет.',
        '22': 'От мързел няма да се отървеш, за тебе друг ще бачка щеш не щеш!',
        '23': 'На колегите от сърце се усмихни, догодина от Хавай ще им пращаш поздрави!',
        '24': 'Батериите здраво зареди – за тиймбилдинг на круиз се приготви!',
        '25': 'Дори да има в обществото кризи, ще ги изкараш на петзвездни круизи!',
        '26': 'Няма бариера пред твоята кариера. Работата ще е песен, а живота ти чудесен!'
    }

    createApp({
        data() {
            return {
                lucks: [],
                luck: '',
                emails: [],
                email: {},
                wish: '',
                emailPrefix: "",
                inputOpen: false,
                congrats: false
            }
        },
        computed: {
            fullEmail() {
                return this.emailPrefix + this.emailSuffix;
            },
            emailSuffix() {
                return "@vizitec.com";
            },
        },
        async mounted() {
            await this.setLocalState();
        },
        methods: {
            async choosePiece() {
                // email = prompt('Въведи e-mail');
                await this.setLocalState();
                // const emailIndex = this.emails.findIndex(obj => obj.email === email);
                const emailIndex = this.emails.findIndex(obj => obj.email === this.fullEmail);

                console.log(this.emails);

                if (emailIndex > -1) {
                    this.inputOpen = false;
                    this.email = this.emails[emailIndex]
                    this.emails[emailIndex].luck.length
                        ? this.wish = wishes[this.emails[emailIndex].luck]
                        : this.pickLuck();
                } else {
                    alert('Въведен е невалиден e-mail');
                }
            },
            async pickLuck() {
                await this.setLocalState();
                this.luck = this.lucks[Math.round(Math.random() * (this.lucks.length - 1))];
                this.wish = wishes[this.luck];
                await this.setLuckRemote();
                await this.setLocalState();
            },
            async setLocalState() {
                this.emails = await this.getAllEmails();
                const usedLucks = this.emails.map(email => email.luck);
                this.lucks = allLucks.filter(luck => !usedLucks.includes(luck));
            },
            async getAllEmails() {
                const emailsResponse = await fetch(getAllUrl, { headers });
                const emailsResult = await emailsResponse.json();
                return emailsResult.results;
            },
            async setLuckRemote() {
                const luckResponse = await fetch(setLuckUrl(this.email.objectId), {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({ luck: this.luck })
                });
            },
            onBanitzaClick() {
                const audio = this.$refs.xMusic;

                if (audio && audio.paused) {
                    audio.play().catch(() => {
                        console.warn("Autoplay blocked until user interaction");
                    });
                }
                this.inputOpen=true;
            },
            toCongrats() {
                this.wish = '';
                this.congrats = true;
            }
        }
    }).mount('#app')
</script>

<style>
    body {
        background: url("assets/bkg.png");
        background-size: cover;
    }

    #app {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .banitza {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .banitza-img {
        width: 100%;
        height: auto;
        animation: spin 2.5s ease-out 1;
        cursor: pointer;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(720deg);
        }
    }

    .piece {
        cursor: pointer;
        background-color: yellow;
        padding: 5px
    }

    @font-face {
        font-family: "ClassRoomCursiveSwash";
        src: url("assets/ClassRoomCursiveSwash.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
    }

    .mask {
        width: 100%;
        height: 100%;
        position: absolute;
        background-color: rgb(0, 0, 0, 0.3);
        top: 0;
        left: 0;
    }

    .wish {
        width: 375px;
        height: 225.5px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        background: url("assets/papyrus.png");
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    strong {
        padding-inline: 2rem;
        font-family: "ClassRoomCursiveSwash";
        font-size: xx-large;
    }

    .close {
        position: absolute;
        top: 1rem;
        right: 2rem;
        cursor: pointer;
    }

    .close span {
        font-family: 'Courier New';
        margin: 0.2rem
    }

    .email-input {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin-top: 3rem;
        font-size: 1.2rem;
        gap: 0.5rem;
        text-align: center;
    }

    .email-input input {
        background: transparent;
        padding: 8px 10px;
        font-size: 1.2rem;
        border: 1px solid #ccc;
        border-radius: 6px 0 0 6px;
        outline: none;
        width: fit-content;
    }

    .email-suffix {
        padding: 8px 10px;
        background: #eee;
        border: 1px solid #ccc;
        border-left: none;
        border-radius: 0 6px 6px 0;
        font-size: 1.2rem;
        color: #555;
        cursor: pointer;
    }

    .email-suffix:hover {
        background: #fff;
    }

    .footer {
        width: 100%;
        position: absolute;
        display: flex;
        justify-content: center;
        align-items: center;
        bottom: 1rem;
        left: 0;
    }

    .congrats {
        width: 480px;
        height: 270px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        background: url("assets/wishes.png");
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .footer span {
        padding-inline: 2rem;
        font-family: "ClassRoomCursiveSwash";
        font-size: xx-large;
        text-align: center;
    }
</style>

