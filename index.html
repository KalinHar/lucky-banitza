<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <title>БАНИЦА</title>
</head>
<body>
    <div id="app">
        <div class="banitza">
            <img 
                class="banitza-img"
                :src="`./assets/${lucks.length}.png`"
                @click="choosePiece">
        </div>
    </div>
</body>
</html>

<script>
    const { createApp } = Vue;

    const getAllUrl = 'https://parseapi.back4app.com/classes/vizitec';
    const setLuckUrl = (id) => `${getAllUrl}/${id}`;
    const headers = {
        'X-Parse-Application-Id': 'bRrAggyHMoMVL9uPNl4T9XPzDFxHMRIrxTEieDEN',
        'X-Parse-REST-API-Key': 'oyNNM1odjhrSzfCkWtVmkFTiZPgmZUelFFkE5uhX'
    }

    const allLucks = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26'];

    createApp({
        data() {
            return {
                lucks: [],
                luck: '',
                emails: [],
                email: {},
            }
        },
        async mounted() {
            await this.setLocalState();
        },
        methods: {
            async choosePiece() {
                email = prompt('Въведи e-mail');
                await this.setLocalState();
                const emailIndex = this.emails.findIndex(obj => obj.email === email);

                console.log(this.emails);

                if (emailIndex > -1) {
                    this.email = this.emails[emailIndex]
                    this.emails[emailIndex].luck.length
                        ? alert('Вече си изтеглил късмет от баницата!')
                        : this.pickLuck();
                } else {
                    alert('Въведен е невалиден e-mail');
                }
            },
            async pickLuck() {
                await this.setLocalState();
                this.luck = this.lucks[Math.round(Math.random() * (this.lucks.length - 1))];
                console.log(this.luck);
                await this.setLuckRemote();
                await setLocalState();
            },
            async setLocalState() {
                this.emails = await this.getAllEmails();
                const usedLucks = this.emails.map(email => email.luck);
                this.lucks = allLucks.filter(luck => !usedLucks.includes(luck));
            },
            async getAllEmails() {
                const emailsResponse = await fetch(getAllUrl, { headers });
                const emailsResult = await emailsResponse.json();
                return emailsResult.results;
            },
            async setLuckRemote() {
                const luckResponse = await fetch(setLuckUrl(this.email.objectId), {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({luck: this.luck})
                });
            }
        }
    }).mount('#app')
</script>

<style>
    .banitza {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }
    .banitza-img {
        height: 80vh
    }
    .piece {
        cursor: pointer;
        background-color: yellow;
        padding: 5px
    }
</style>