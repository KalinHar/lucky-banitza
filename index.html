<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="assets/26.png">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <title>БАНИЦА</title>
</head>

<body>
    <div id="app">
        <div class="header">
            <span>Заповядайте на баницата! Моля, не бъдете лакоми, количествата са ограничени!</span>
        </div>
        <div class="banitza">
            <img :class="[spin ? 'banitza-anim' : '', 'banitza-img']" :src="`./assets/${lucks.length}.png`" @click="inputOpen = true">
        </div>
        <div v-if="inputOpen" class="mask">
            <div class="email-input">
                <div class="close" @click="inputOpen = false">
                    <span class="close-email">x</span>
                </div>
                <!-- <label>С баница се почерпи и късметче получи</label> -->
                <div class="flex">
                    <input type="text" v-model="emailPrefix" placeholder="username" />
                    <span type="button" class="email-suffix" @click="choosePiece">{{emailSuffix}}</span>
                </div>
            </div>
        </div>
        <div v-if="luck" class="mask">
            <div class="luck">
                <div class="close" @click="toCongrats">
                    <span>x</span>
                </div>
                <strong>{{luck}}</strong>
            </div>
        </div>

        <div v-if="congrats" class="full">
            <div class="close-grandpa" @click="toCongrats">
                <span>x</span>
            </div>
            <img src="assets/wishes.png" class="congrats">
        </div>

        <div class="lucks">
            <template v-for="email in emails">
                <div v-if="email.luck.length > 0">
                    <p>{{email.name}}: {{email.luck}}</p>
                </div>
            </template>
        </div>
    </div>
</body>

</html>

<script>
    const { createApp } = Vue;

    const getAllUrl = 'https://parseapi.back4app.com/classes/vizitec';
    const setLuckUrl = (id) => `${getAllUrl}/${id}`;
    const headers = {
        'X-Parse-Application-Id': 'bRrAggyHMoMVL9uPNl4T9XPzDFxHMRIrxTEieDEN',
        'X-Parse-REST-API-Key': 'oyNNM1odjhrSzfCkWtVmkFTiZPgmZUelFFkE5uhX'
    }

    const allLucks = [
        'Повишение със сигурност ще имаш ти, защото шефа страшно те цени.',
        'Стягай се за почерпка отсега – през новата година ще подкараш нова кола.',
        'На вратата, като че ли нещо тебе чака и това не са сметките за тока и водата...Май са топка пелени и бебенце ще чакаш ти.',
        'Очакват те безброй нови имоти, купени с неочаквани наследствени банкноти.',
        'Любов ще грее силно твоето сърце, като чисто ново циганско кюмбе.',
        'Хм, я вземи чадъра и наопаки го обърни, че за теб от утре започва порой от пари.',
        'Знаем, хич не ти спори учението. Затова на теб се пада приключението.',
        'Безкрайно веселие и купон подир купон, от тебе се очаква само да даваш тон!',
        'На тебе мързелът се пада – да мързелуваш ти приляга!',
        'Плюй си на петите и беж, че очаква те годеж!',
        'Най-голямата награда – здравето – на теб се пада!',
        'Годината ще е добра, ще я отбележиш с пътуване до тайнствена страна!',
        'Ще бъдеш със сила и смелост окрилен, повече даже и от Спайдърмен!',
        'Стилна къща с камина пада ти се таз година! С двор, с гараж и с куче – нов, мечтан дом ще получиш!',
        'Ех, най-добрия късмет случи – пада ти се здраве и благополучие! ',
        'Хич да не ти пука – догодина наслука!',
        'Късметът на теб се пада, ще си облечен в дрехи на Прада!',
        'Кариерата ще ти е приоритет, ще се изкачваш смело напред!',
        'Няма да се отървеш от фенки, ще им трябват наколенки.',
        'Раничката си стегни, ще караш ски във чужди планини!',
        'Щастието ще е с теб, ще отидеш на гурбет.',
        'От мързел няма да се отървеш, за тебе друг ще бачка щеш не щеш!',
        'На колегите от сърце се усмихни, догодина от Хавай ще им пращаш поздрави!',
        'Батериите здраво зареди – за тиймбилдинг на круиз се приготви!',
        'Дори да има в обществото кризи, ще ги изкараш на петзвездни круизи!',
        'Няма бариера пред твоята кариера. Работата ще е песен, а живота ти чудесен!'
    ];

    createApp({
        data() {
            return {
                lucks: [],
                luck: '',
                emails: [],
                email: {},
                emailPrefix: "",
                inputOpen: false,
                congrats: false,
                spin: false
            }
        },
        computed: {
            fullEmail() {
                return this.emailPrefix.toLowerCase() + this.emailSuffix;
            },
            emailSuffix() {
                return "@vizitec.com";
            },
        },
        async mounted() {
            await this.setLocalState();

            // Clear remote lucks

            // for await (const email of this.emails) {
            //     if (email.luck.length > 0)
            //         fetch(`https://parseapi.back4app.com/classes/vizitec/${email.objectId}`, {
            //             method: 'PUT',
            //             body: JSON.stringify({ luck: '' }),
            //             headers
            //         });
            // }
        },
        methods: {
            async choosePiece() {
                // email = prompt('Въведи e-mail');
                await this.setLocalState();
                // const emailIndex = this.emails.findIndex(obj => obj.email === email);
                const emailIndex = this.emails.findIndex(obj => obj.email === this.fullEmail);


                if (emailIndex > -1) {
                    this.inputOpen = false;
                    this.email = this.emails[emailIndex]
                    this.emails[emailIndex].luck.length
                        ? alert('Вече си изтеглил късмет от баницата!')
                        : this.pickLuck();
                } else {
                    alert('Въведен е невалиден e-mail');
                }
            },
            async pickLuck() {
                this.spin = true;
                await this.setLocalState();
                await setTimeout(async () => {
                    this.luck = this.lucks[Math.round(Math.random() * (this.lucks.length - 1))];
                    await this.setLuckRemote();
                    await this.setLocalState();
                }, 2500);
            },
            async setLocalState() {
                this.emails = await this.getAllEmails();
                this.emails.forEach(email => !email.luck.length ? console.log(email.email) : null)
                const usedLucks = this.emails.map(email => email.luck);
                this.lucks = allLucks.filter(luck => !usedLucks.includes(luck));
            },
            async getAllEmails() {
                const emailsResponse = await fetch(getAllUrl, { headers });
                const emailsResult = await emailsResponse.json();
                return emailsResult.results;
            },
            async setLuckRemote() {
                const luckResponse = await fetch(setLuckUrl(this.email.objectId), {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({ luck: this.luck })
                });
            },
            toCongrats() {
                this.luck = '';
                this.congrats = !this.congrats;
                this.spin = false;
            }
        }
    }).mount('#app')
</script>

<style>
    /* @font-face {
        font-family: "ClassRoomCursiveSwash";
        src: url("assets/ClassRoomCursiveSwash.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
    } */

    /* @font-face {
        font-family: "Roboto";
        src: url("assets/Roboto-Regular.ttf") format("truetype")
    } */
    
    @font-face {
        font-family: "Nautilus";
        src: url("assets/Nautilus.otf");
    }

    body {
        background: url("assets/bkg.png");
        background-size: cover;
        font-family: "Nautilus";
    }

    #app {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .banitza {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .banitza-img {
        width: 100%;
        height: auto;
        cursor: pointer;
    }

    .banitza-anim {
        animation: spin 2.5s ease-out 1;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(720deg);
        }
    }

    .piece {
        cursor: pointer;
        background-color: yellow;
        padding: 5px
    }

    .mask {
        padding: 5rem;
        position: absolute;
        background-color: rgb(0, 0, 0, 0.3);
        top: 12rem;
    }

    .luck {
        width: 375px;
        height: 225.5px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        background: url("assets/papyrus.png");
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .lucks {
        width: 100%;
        padding: 1rem;
    }

    strong {
        padding-inline: 2rem;
        font-size: xx-large;
    }

    .close {
        position: absolute;
        top: 1rem;
        right: 2rem;
        cursor: pointer;
    }

    .close-grandpa {
        position: absolute;
        top: 1rem;
        cursor: pointer;
        width: 100%;
        max-width: 500px;
        display: flex;
        justify-content: flex-end;
        padding-right: 1rem;
    }

    .close-grandpa span,
    .close span {
        font-family: 'Courier New';
        margin: 0.2rem
    }

    .close-congrats {
        position: absolute;
        top: 45%;
        right: 45%;
        cursor: pointer;
    }

    .email-input {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        gap: 0.5rem;
        text-align: center;
    }

    .email-input input {
        width: 7rem !important;
        padding: 8px 10px;
        font-size: 1.2rem;
        border: 1px solid #ccc;
        border-radius: 6px 0 0 6px;
        outline: none;
        width: fit-content;
    }

    .email-suffix {
        padding: 8px 10px;
        background: #eee;
        border: 1px solid #ccc;
        border-left: none;
        border-radius: 0 6px 6px 0;
        font-size: 1.2rem;
        color: #555;
        cursor: pointer;
    }

    .email-suffix:hover {
        background: #fff;
    }

    .header {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .header span {
        padding-inline: 2rem;
        font-size: x-large;
        text-align: center;
    }

    .congrats {
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 500px;
    }

    .close-email {
        background-color: white;
        padding: .3rem;
        border-radius: 3px;
    }

    .full {
        width: 100%;
        position: absolute;
        top: 10%;
        display: flex;
        justify-content: center;
    }

    .flex {
        display: flex;
    }
</style>


